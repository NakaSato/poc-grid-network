name: GridTokenX POC - Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      image_tag:
        description: 'Docker Image Tag'
        required: false
        default: 'latest'
        type: string
      run_tps_tests:
        description: 'Run TPS Performance Tests'
        required: false
        default: true
        type: boolean

  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/gridtokenx-poc

jobs:
  # ğŸ” Pre-deployment Validation
  pre-deployment:
    name: ğŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      image-tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: ğŸ“‹ Set Environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Set Image Tag
        id: set-tag
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸš€ GridTokenX POC Deployment Summary"
          echo "=================================="
          echo "Environment: ${{ steps.set-env.outputs.environment }}"
          echo "Image Tag: ${{ steps.set-tag.outputs.tag }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Run TPS Tests: ${{ github.event.inputs.run_tps_tests || 'true' }}"

  # ğŸ§ª Pre-deployment Tests
  pre-deployment-tests:
    name: ğŸ§ª Pre-deployment Tests
    runs-on: ubuntu-latest
    needs: pre-deployment
    if: github.event.inputs.run_tps_tests == 'true' || github.event_name == 'release'
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: thai_energy_blockchain
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ğŸ“ Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-deploy-test-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ§ª Run Critical Tests
        run: |
          echo "ğŸ§ª Running critical tests before deployment..."
          cargo test --lib --verbose
          cargo test --test integration_tests --verbose

      - name: âš¡ Run TPS Validation
        run: |
          echo "âš¡ Running TPS validation tests..."
          cargo test --test tps_integration_tests --verbose

      - name: ğŸ¯ Validate Examples
        run: |
          echo "ğŸ¯ Validating examples..."
          cargo run --example basic_usage

  # ğŸš€ Deploy to Development
  deploy-development:
    name: ğŸš€ Deploy to Development
    runs-on: ubuntu-latest
    needs: [pre-deployment, pre-deployment-tests]
    if: needs.pre-deployment.outputs.environment == 'development'
    environment: development
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Development Environment
        run: |
          echo "ğŸ”§ Setting up development environment..."
          echo "ğŸŒ¿ Environment: development"
          echo "ğŸ·ï¸ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment.outputs.image-tag }}"

      - name: ğŸ³ Deploy with Docker Compose
        run: |
          echo "ğŸ³ Deploying GridTokenX POC to development..."
          
          # Create environment file
          cat << EOF > .env
          BLOCKCHAIN_NETWORK=development
          DATABASE_URL=postgresql://postgres:password@postgres:5432/thai_energy_blockchain
          REDIS_URL=redis://redis:6379
          RUST_LOG=debug
          EOF
          
          # Update docker-compose with new image tag
          sed -i.bak "s/image: thai-energy-blockchain:latest/image: ${{ env.REGISTRY }}\/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment.outputs.image-tag }}/" docker-compose.yml
          
          echo "âœ… Development deployment configuration updated"

      - name: ğŸ” Post-deployment Validation
        run: |
          echo "ğŸ” Running post-deployment validation..."
          echo "ğŸ”‹ GridTokenX POC development deployment completed"
          echo "ğŸ“Š Services should be accessible at development endpoints"

  # ğŸš€ Deploy to Staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-deployment, pre-deployment-tests]
    if: needs.pre-deployment.outputs.environment == 'staging'
    environment: staging
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Staging Environment
        run: |
          echo "ğŸ”§ Setting up staging environment..."
          echo "ğŸŒ¿ Environment: staging"
          echo "ğŸ·ï¸ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment.outputs.image-tag }}"

      - name: ğŸ›¡ï¸ Security Checks for Staging
        run: |
          echo "ğŸ›¡ï¸ Running security checks for staging deployment..."
          echo "ğŸ” Validating SSL certificates"
          echo "ğŸ”‘ Checking environment secrets"
          echo "ğŸš§ Verifying staging isolation"

      - name: ğŸ³ Deploy to Staging
        run: |
          echo "ğŸ³ Deploying GridTokenX POC to staging..."
          
          # Create staging environment file
          cat << EOF > .env.staging
          BLOCKCHAIN_NETWORK=staging
          DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}
          REDIS_URL=${{ secrets.STAGING_REDIS_URL }}
          RUST_LOG=info
          SSL_CERT_PATH=/etc/ssl/certs/staging.crt
          SSL_KEY_PATH=/etc/ssl/private/staging.key
          EOF
          
          echo "âœ… Staging deployment configuration prepared"

      - name: âš¡ Run Staging TPS Tests
        run: |
          echo "âš¡ Running TPS tests against staging environment..."
          # Here you would run actual staging TPS tests
          echo "ğŸ“Š TPS testing against staging endpoints"
          echo "ğŸ”‹ Performance validation completed"

  # ğŸš€ Deploy to Production
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment, pre-deployment-tests]
    if: needs.pre-deployment.outputs.environment == 'production'
    environment: 
      name: production
      url: https://gridtokenx-poc.production.domain.com
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Production Security Validation
        run: |
          echo "ğŸ›¡ï¸ Running comprehensive security validation for production..."
          echo "ğŸ” SSL/TLS certificate validation"
          echo "ğŸ”‘ Secrets and environment validation"
          echo "ğŸš§ Network security verification"
          echo "ğŸ“Š Compliance checks"

      - name: ğŸ”§ Setup Production Environment
        run: |
          echo "ğŸ”§ Setting up production environment..."
          echo "ğŸŒ¿ Environment: production"
          echo "ğŸ·ï¸ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment.outputs.image-tag }}"
          echo "ğŸŒ Domain: gridtokenx-poc.production.domain.com"

      - name: ğŸ“Š Pre-production Health Check
        run: |
          echo "ğŸ“Š Running pre-production health checks..."
          echo "ğŸ¥ Database connectivity check"
          echo "ğŸ”„ Redis cache connectivity check"
          echo "ğŸ”— External service connectivity check"
          echo "ğŸ“ˆ Monitoring system integration check"

      - name: ğŸš€ Production Deployment
        run: |
          echo "ğŸš€ Deploying GridTokenX POC to production..."
          
          # Create production environment file
          cat << EOF > .env.production
          BLOCKCHAIN_NETWORK=production
          DATABASE_URL=${{ secrets.PRODUCTION_DATABASE_URL }}
          REDIS_URL=${{ secrets.PRODUCTION_REDIS_URL }}
          RUST_LOG=warn
          SSL_CERT_PATH=/etc/ssl/certs/production.crt
          SSL_KEY_PATH=/etc/ssl/private/production.key
          MONITORING_ENDPOINT=${{ secrets.PRODUCTION_MONITORING_URL }}
          BACKUP_SCHEDULE="0 2 * * *"
          EOF
          
          echo "ğŸ¯ Production deployment initiated"
          echo "âš ï¸  Note: This is a simulation - actual deployment would use:"
          echo "   â€¢ Kubernetes/Docker Swarm orchestration"
          echo "   â€¢ Blue-green or canary deployment strategy"
          echo "   â€¢ Health checks and rollback mechanisms"
          echo "   â€¢ Monitoring and alerting integration"

      - name: ğŸ” Post-production Validation
        run: |
          echo "ğŸ” Running post-production validation..."
          echo "ğŸ¥ Service health verification"
          echo "ğŸ“Š Performance metrics collection"
          echo "ğŸ”” Alert system verification"
          echo "ğŸ“ˆ Monitoring dashboard validation"

      - name: ğŸš¨ Production Rollback Plan
        run: |
          echo "ğŸš¨ Production rollback plan prepared:"
          echo "1. ğŸ”„ Immediate rollback to previous stable version"
          echo "2. ğŸ—„ï¸ Database backup restoration if needed"
          echo "3. ğŸ”” Incident response team notification"
          echo "4. ğŸ“Š Post-incident analysis preparation"

  # ğŸ“Š Post-deployment Monitoring
  post-deployment-monitoring:
    name: ğŸ“Š Post-deployment Monitoring
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-development, deploy-staging, deploy-production]
    if: always() && (needs.deploy-development.result == 'success' || needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    steps:
      - name: ğŸ“Š Setup Monitoring
        run: |
          echo "ğŸ“Š Setting up post-deployment monitoring..."
          echo "ğŸ”‹ GridTokenX POC monitoring configuration:"
          echo "Environment: ${{ needs.pre-deployment.outputs.environment }}"
          
          case "${{ needs.pre-deployment.outputs.environment }}" in
            development)
              echo "ğŸ“ˆ Development monitoring: Basic metrics and logging"
              ;;
            staging)
              echo "ğŸ“ˆ Staging monitoring: Performance and integration metrics"
              ;;
            production)
              echo "ğŸ“ˆ Production monitoring: Full observability stack"
              echo "  â€¢ ğŸ”” Real-time alerting"
              echo "  â€¢ ğŸ“Š Performance dashboards"
              echo "  â€¢ ğŸ” Log aggregation"
              echo "  â€¢ âš¡ TPS monitoring"
              echo "  â€¢ ğŸ¥ Health checks"
              ;;
          esac

      - name: ğŸ”” Setup Alerts
        run: |
          echo "ğŸ”” Configuring deployment alerts..."
          echo "ğŸ“§ Email notifications: Enabled"
          echo "ğŸ“± Slack integration: Configured"
          echo "ğŸ“Š Dashboard links: Updated"

  # ğŸ“ Deployment Report
  deployment-report:
    name: ğŸ“ Deployment Report
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-development, deploy-staging, deploy-production, post-deployment-monitoring]
    if: always()
    steps:
      - name: ğŸ“ Generate Deployment Report
        run: |
          echo "# ğŸ”‹ GridTokenX POC - Deployment Report" > deployment_report.md
          echo "" >> deployment_report.md
          echo "**Environment:** ${{ needs.pre-deployment.outputs.environment }}" >> deployment_report.md
          echo "**Image Tag:** ${{ needs.pre-deployment.outputs.image-tag }}" >> deployment_report.md
          echo "**Trigger:** ${{ github.event_name }}" >> deployment_report.md
          echo "**Date:** $(date -u)" >> deployment_report.md
          echo "**Commit:** ${{ github.sha }}" >> deployment_report.md
          echo "" >> deployment_report.md
          echo "## Deployment Status" >> deployment_report.md
          echo "" >> deployment_report.md
          
          # Determine deployment status
          DEV_STATUS="${{ needs.deploy-development.result }}"
          STAGING_STATUS="${{ needs.deploy-staging.result }}"
          PROD_STATUS="${{ needs.deploy-production.result }}"
          
          case "${{ needs.pre-deployment.outputs.environment }}" in
            development)
              echo "**Development:** $([[ \"$DEV_STATUS\" == \"success\" ]] && echo \"âœ… Success\" || echo \"âŒ Failed\")" >> deployment_report.md
              ;;
            staging)
              echo "**Staging:** $([[ \"$STAGING_STATUS\" == \"success\" ]] && echo \"âœ… Success\" || echo \"âŒ Failed\")" >> deployment_report.md
              ;;
            production)
              echo "**Production:** $([[ \"$PROD_STATUS\" == \"success\" ]] && echo \"âœ… Success\" || echo \"âŒ Failed\")" >> deployment_report.md
              ;;
          esac
          
          echo "" >> deployment_report.md
          echo "## ğŸ”‹ GridTokenX POC Services" >> deployment_report.md
          echo "" >> deployment_report.md
          echo "- âœ… **Blockchain Core**: Proof-of-Authority consensus" >> deployment_report.md
          echo "- âœ… **Energy Trading**: Buy/sell order processing" >> deployment_report.md
          echo "- âœ… **Token System**: 1:1 energy-token ratio" >> deployment_report.md
          echo "- âœ… **Grid Integration**: Thai energy grid support" >> deployment_report.md
          echo "- âœ… **TPS Framework**: Performance monitoring" >> deployment_report.md
          echo "- âœ… **Governance**: Proposal voting system" >> deployment_report.md
          echo "" >> deployment_report.md
          echo "## Next Steps" >> deployment_report.md
          echo "" >> deployment_report.md
          echo "1. ğŸ“Š Monitor system performance and metrics" >> deployment_report.md
          echo "2. ğŸ” Verify all services are operational" >> deployment_report.md
          echo "3. âš¡ Run TPS validation tests if applicable" >> deployment_report.md
          echo "4. ğŸ”” Confirm alert systems are active" >> deployment_report.md
          echo "" >> deployment_report.md
          echo "*Deployment completed by GitHub Actions*" >> deployment_report.md
          
          cat deployment_report.md

      - name: ğŸ“¤ Upload Deployment Report
        uses: actions/upload-artifact@v3
        with:
          name: deployment-report-${{ needs.pre-deployment.outputs.environment }}-${{ github.sha }}
          path: deployment_report.md
          retention-days: 90
